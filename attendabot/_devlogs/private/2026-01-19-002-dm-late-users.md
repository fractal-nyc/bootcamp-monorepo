# 2026-01-19-002: DM Late Users Instead of Channel Message

## Summary

Changed attendance/EOD verification to send private DMs to users who haven't posted instead of publicly calling them out in the channel. Also limited PR leaderboard to top 3 places (with ties).

## Problem

The bot was publicly mentioning users who hadn't posted their attendance/EOD updates in the channel, which could feel like public shaming. A more considerate approach is to DM users privately.

Additionally, the PR leaderboard showed everyone, which became cluttered. Showing only top 3 makes it more focused and celebratory.

## What We Did

### 1. Direct Message Helper (`backend/src/services/discord.ts`)

Added reusable function for sending DMs:

```typescript
export async function sendDirectMessage(userId: string, message: string): Promise<boolean> {
  const discordClient = getDiscordClient();
  if (!isReady) return false;

  try {
    const user = await discordClient.users.fetch(userId);
    await user.send(message);
    return true;
  } catch (error) {
    console.error(`Failed to send DM to user ${userId}:`, error);
    return false;
  }
}
```

### 2. Private Reminders (`backend/src/bot/index.ts`)

Replaced public channel message with individual DMs:

```typescript
// Before: Public mention in channel
const mentionList = missingUsers.map((id) => `<@${id}>`).join(", ");
await channel.send({
  content: `The following engineers still need to post their ${label} update...`
});

// After: Private DM to each user
for (const userId of missingUsers) {
  const sent = await sendDirectMessage(
    userId,
    `Reminder: You still need to post your ${label} update for ${getCurrentMonthDay()} in #${channel.name}.`
  );
  if (sent) {
    incrementMessagesSent();
    dmsSent++;
  }
}
console.log(`Sent ${label} reminder DMs to ${dmsSent}/${missingUsers.length} users`);
```

### 3. Top 3 PR Leaderboard (`backend/src/bot/index.ts`)

Refactored leaderboard to show only top 3 places with tie handling:

```typescript
// Sort by PR count descending
const sorted = Array.from(userPullRequestCounts.entries())
  .map(([userId, count]) => ({
    name: USER_ID_TO_NAME_MAP.get(userId) ?? "Unknown User",
    count,
  }))
  .sort((a, b) => b.count - a.count);

// Get top 3 places (include ties)
const top3: typeof sorted = [];
let currentRank = 0;
let lastCount = -1;

for (const entry of sorted) {
  if (entry.count !== lastCount) {
    currentRank++;
    if (currentRank > 3) break;
    lastCount = entry.count;
  }
  top3.push(entry);
}

if (top3.length > 0) {
  const leaderboard = top3.map((e) => `${e.name}: ${e.count}`).join("\n");
  await channel.send({
    content: `PR Leaderboard for ${getCurrentMonthDay()} (Top 3):\n${leaderboard}`,
  });
}
```

## Design Decisions

1. **Private DMs over public mentions**: More respectful approach to reminders
2. **Track DM success rate**: Log shows `dmsSent/total` to monitor delivery issues
3. **Top 3 with ties**: If 3 people tie for first, all 3 shown. Rank increments only on count change.
4. **Only show if entries exist**: Skip leaderboard message if no one posted PRs

## Results

- Late users receive private reminders instead of public call-outs
- Less noisy channel messages
- PR leaderboard focused on top performers
- Better logging for monitoring DM delivery
